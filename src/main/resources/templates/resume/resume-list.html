<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
  <title>ìì†Œì„œ ëª©ë¡</title>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

  <!-- í˜ì´ì§€ë³„ ì¶”ê°€ CSS -->
  <th:block layout:fragment="css">
    <style>
      /* ì»¨í…Œì´ë„ˆ ì¬ì •ì˜ */
      .main-content .container {
        max-width: 1200px !important;
        margin: 0 auto !important;
        padding: 2rem 1rem !important;
      }

      /* í˜ì´ì§€ í—¤ë” */
      .page-header {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        padding: 2rem 0;
      }

      .page-header-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .page-header-left h1 {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
      }

      .page-header-left p {
        color: #6b7280;
        font-size: 0.95rem;
      }

      .new-resume-btn {
        background: #3b82f6;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        border: none;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        transition: background-color 0.2s ease;
        font-size: 0.875rem;
      }

      .new-resume-btn:hover {
        background: #2563eb;
        color: white;
        text-decoration: none;
      }

      /* í†µê³„ ì„¹ì…˜ */
      .stats-section {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        border-left: 4px solid;
      }

      .stat-card.total { border-left-color: #3b82f6; }
      .stat-card.completed { border-left-color: #10b981; }
      .stat-card.in-progress { border-left-color: #f59e0b; }

      .stat-number {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
      }

      .stat-card.total .stat-number { color: #3b82f6; }
      .stat-card.completed .stat-number { color: #10b981; }
      .stat-card.in-progress .stat-number { color: #f59e0b; }

      .stat-label {
        color: #6b7280;
        font-size: 0.875rem;
        font-weight: 500;
      }

      /* í•„í„° ë° ê²€ìƒ‰ ì„¹ì…˜ */
      .filter-section {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .search-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 1.5rem;
        align-items: center;
      }

      .search-input {
        flex: 1;
        padding: 0.75rem 1rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%236b7280" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>') no-repeat 1rem center;
        padding-left: 2.5rem;
      }

      .search-input:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .filter-buttons {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .filter-group {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .filter-group.left {
        flex: 1;
      }

      .filter-group.right {
        flex-shrink: 0;
      }

      .filter-btn {
        padding: 0.5rem 1rem;
        border: 1px solid #d1d5db;
        background: white;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #6b7280;
      }

      .filter-btn:hover {
        border-color: #3b82f6;
        color: #3b82f6;
      }

      .filter-btn.active {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
      }

      .sort-dropdown {
        position: relative;
      }

      .sort-button {
        padding: 0.5rem 1rem;
        border: 1px solid #d1d5db;
        background: white;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        color: #374151;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        min-width: 100px;
        justify-content: space-between;
      }

      .sort-button:hover {
        border-color: #3b82f6;
        color: #3b82f6;
      }

      .sort-button .arrow {
        font-size: 0.6rem;
        color: #9ca3af;
        transition: transform 0.2s ease;
      }

      .sort-dropdown.show .sort-button .arrow {
        transform: rotate(180deg);
      }

      .sort-dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        z-index: 10;
        min-width: 120px;
        display: none;
      }

      .sort-dropdown-menu.show {
        display: block;
      }

      .sort-option {
        padding: 0.75rem 1rem;
        cursor: pointer;
        font-size: 0.875rem;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        transition: background-color 0.2s ease;
      }

      .sort-option:hover {
        background: #f3f4f6;
      }

      .sort-option:first-child {
        border-radius: 0.5rem 0.5rem 0 0;
      }

      .sort-option:last-child {
        border-radius: 0 0 0.5rem 0.5rem;
      }

      /* ìì†Œì„œ ê·¸ë¦¬ë“œ */
      .resume-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .resume-card {
        background: white;
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: all 0.2s ease;
        cursor: pointer;
        border: 1px solid #e5e7eb;
        position: relative;
      }

      .resume-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }

      .resume-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.5rem;
      }

      .resume-company {
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 1rem;
      }

      /* ìƒíƒœ ì„ íƒ ë“œë¡­ë‹¤ìš´ */
      .status-dropdown {
        position: relative;
        display: inline-block;
      }

      .status-dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 0.375rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        min-width: 100px;
        display: none;
        overflow: hidden;
      }

      .status-dropdown-menu.show {
        display: block;
      }

      .status-option {
        padding: 0.5rem 0.75rem;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: 500;
        border: none;
        background: none;
        width: 100%;
        text-align: left;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .status-option:hover {
        background: #f3f4f6;
      }

      .status-option.completed {
        color: #065f46;
      }

      .status-option.writing {
        color: #92400e;
      }

      .status-option .status-icon {
        width: 8px;
        height: 8px;
        border-radius: 50%;
      }

      .status-option.completed .status-icon {
        background: #10b981;
      }

      .status-option.writing .status-icon {
        background: #f59e0b;
      }

      .status-badge {
        display: inline-block;
        font-size: 0.75rem;
        font-weight: 500;
        padding: 0.25rem 0.75rem;
        border-radius: 0.5rem;
        margin-bottom: 1.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        user-select: none;
        position: relative;
      }

      .status-badge:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .status-completed {
        background: #d1fae5;
        color: #065f46;
        border-color: #10b981;
      }

      .status-completed:hover {
        background: #a7f3d0;
      }

      .status-writing {
        background: #fef3c7;
        color: #92400e;
        border-color: #f59e0b;
      }

      .status-writing:hover {
        background: #fde68a;
      }

      .resume-dates {
        display: flex;
        justify-content: space-between;
        font-size: 0.75rem;
        color: #9ca3af;
        padding-top: 1rem;
        border-top: 1px solid #f3f4f6;
      }

      .resume-actions {
        display: none;
        position: absolute;
        top: 1.5rem;
        right: 1.5rem;
        gap: 0.5rem;
        align-items: flex-start;
      }

      .resume-card:hover .resume-actions {
        display: flex;
      }

      .action-btn {
        width: 2rem;
        height: 2rem;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        transition: all 0.2s ease;
      }

      .edit-btn {
        background: #eff6ff;
        color: #2563eb;
      }

      .edit-btn:hover {
        background: #dbeafe;
      }

      .delete-btn {
        background: #fef2f2;
        color: #dc2626;
      }

      .delete-btn:hover {
        background: #fecaca;
      }

      /* í˜ì´ì§€ë„¤ì´ì…˜ */
      .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        margin-top: 2rem;
      }

      .page-btn {
        width: 2.5rem;
        height: 2.5rem;
        border: 1px solid #d1d5db;
        background: white;
        border-radius: 0.375rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.875rem;
        transition: all 0.2s ease;
      }

      .page-btn:hover {
        border-color: #3b82f6;
        color: #3b82f6;
      }

      .page-btn.active {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
      }

      .page-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* ë¹ˆ ìƒíƒœ ë° ì—ëŸ¬ ìƒíƒœ */
      .empty-state {
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        margin: 2rem 0;
      }

      .empty-state .icon {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        opacity: 0.6;
      }

      .empty-state h3 {
        font-size: 1.25rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.75rem;
        line-height: 1.4;
      }

      .empty-state p {
        color: #6b7280;
        font-size: 1rem;
        line-height: 1.5;
        max-width: 400px;
      }

      .empty-state .retry-btn {
        margin-top: 1.5rem;
        padding: 0.75rem 1.5rem;
        background: #3b82f6;
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-weight: 500;
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .empty-state .retry-btn:hover {
        background: #2563eb;
      }

      /* ë¡œë”© ìƒíƒœ */
      .loading {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 4rem;
        color: #6b7280;
      }

      .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #e5e7eb;
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 1s ease-in-out infinite;
        margin-right: 0.75rem;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* ìƒíƒœ ë³€ê²½ ì•Œë¦¼ */
      .status-toast {
        position: fixed;
        top: 2rem;
        right: 2rem;
        background: #10b981;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .status-toast.show {
        opacity: 1;
        transform: translateX(0);
      }

      /* ë°˜ì‘í˜• ë””ìì¸ */
      @media (max-width: 768px) {
        .page-header-content {
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }

        .stats-section {
          grid-template-columns: repeat(3, 1fr);
        }

        .search-bar {
          flex-direction: column;
        }

        .filter-buttons {
          flex-direction: column;
          gap: 1rem;
          align-items: stretch;
        }

        .filter-group.left,
        .filter-group.right {
          justify-content: center;
          flex-wrap: wrap;
          flex: none;
        }

        .sort-dropdown-menu {
          right: auto;
          left: 0;
        }

        .resume-grid {
          grid-template-columns: 1fr;
        }

        .pagination {
          flex-wrap: wrap;
        }

        .resume-actions {
          position: static;
          display: flex;
          justify-content: flex-end;
          margin-top: 1rem;
        }

        .empty-state {
          margin: 1rem 0;
          padding: 2rem 1rem;
        }

        .empty-state .icon {
          font-size: 3rem;
          margin-bottom: 1rem;
        }

        .empty-state h3 {
          font-size: 1.125rem;
        }

        .empty-state p {
          font-size: 0.875rem;
        }
      }

      @media (max-width: 480px) {
        .stats-section {
          grid-template-columns: 1fr;
        }

        .empty-state {
          padding: 1.5rem 1rem;
        }

        .empty-state .icon {
          font-size: 2.5rem;
        }

        .empty-state h3 {
          font-size: 1rem;
        }

        .empty-state p {
          font-size: 0.8rem;
        }

        .empty-state .retry-btn {
          padding: 0.625rem 1.25rem;
          font-size: 0.875rem;
        }
      }
    </style>
  </th:block>
</head>

<body>
<!-- ë©”ì¸ ì½˜í…ì¸  -->
<div layout:fragment="content">
  <!-- í˜ì´ì§€ í—¤ë” -->
  <div class="page-header">
    <div class="page-header-content">
      <div class="page-header-left">
        <h1>ìì†Œì„œ ëª©ë¡</h1>
        <p>ë‚˜ì˜ ëª¨ë“  ìì†Œì„œë¥¼ í•œ ê³³ì—ì„œ ì²´ê³„ì ìœ¼ë¡œ ê´€ë¦¬í•˜ì„¸ìš”</p>
      </div>
      <a href="/resumes/create" class="new-resume-btn">
        âœï¸ ìƒˆ ìì†Œì„œ ì‘ì„±
      </a>
    </div>
  </div>

  <div class="container">
    <!-- í†µê³„ ì„¹ì…˜ -->
    <div class="stats-section">
      <div class="stat-card total">
        <div class="stat-number" id="totalCount">0</div>
        <div class="stat-label">ì „ì²´ ìì†Œì„œ</div>
      </div>
      <div class="stat-card completed">
        <div class="stat-number" id="completedCount">0</div>
        <div class="stat-label">ì™„ë£Œëœ ìì†Œì„œ</div>
      </div>
      <div class="stat-card in-progress">
        <div class="stat-number" id="writingCount">0</div>
        <div class="stat-label">ì‘ì„±ì¤‘</div>
      </div>
    </div>

    <!-- í•„í„° ë° ê²€ìƒ‰ ì„¹ì…˜ -->
    <div class="filter-section">
      <div class="search-bar">
        <input
                type="text"
                class="search-input"
                placeholder="íšŒì‚¬ëª…ì´ë‚˜ ìì†Œì„œ ì œëª©ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”"
                id="searchInput"
        >
      </div>
      <div class="filter-buttons">
        <div class="filter-group left">
          <button class="filter-btn active" data-filter="all">ì „ì²´</button>
          <button class="filter-btn" data-filter="completed">ì™„ë£Œ</button>
          <button class="filter-btn" data-filter="writing">ì‘ì„±ì¤‘</button>
        </div>

        <div class="filter-group right">
          <div class="sort-dropdown">
            <button class="sort-button" id="sortButton">
              <span id="sortButtonText">ìµœì‹ ìˆœ</span>
              <span class="arrow">â–¼</span>
            </button>
            <div class="sort-dropdown-menu" id="sortDropdown">
              <button class="sort-option" data-sort="newest">ìµœì‹ ìˆœ</button>
              <button class="sort-option" data-sort="oldest">ì˜¤ë˜ëœìˆœ</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ë¡œë”© ìƒíƒœ -->
    <div id="loadingState" class="loading">
      <div class="spinner"></div>
      ìì†Œì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
    </div>

    <!-- ìì†Œì„œ ê·¸ë¦¬ë“œ -->
    <div id="resumeGrid" class="resume-grid" style="display: none;">
      <!-- ìì†Œì„œ ì¹´ë“œë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>

    <!-- ë¹ˆ ìƒíƒœ -->
    <div id="emptyState" class="empty-state" style="display: none;">
      <div class="icon">ğŸ“</div>
      <h3 id="emptyTitle">ì•„ì§ ì‘ì„±ëœ ìì†Œì„œê°€ ì—†ìŠµë‹ˆë‹¤</h3>
      <p id="emptyMessage">ì²« ë²ˆì§¸ ìì†Œì„œë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!</p>
      <button id="retryBtn" class="retry-btn" style="display: none;" onclick="loadResumes()">ë‹¤ì‹œ ì‹œë„</button>
    </div>

    <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
    <div id="pagination" class="pagination" style="display: none;">
      <!-- í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ë“¤ì´ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
    </div>
  </div>

  <!-- ìƒíƒœ ë³€ê²½ ì•Œë¦¼ í† ìŠ¤íŠ¸ -->
  <div id="statusToast" class="status-toast">
    ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.
  </div>
</div>

<!-- í˜ì´ì§€ë³„ JavaScript -->
<th:block layout:fragment="script">
  <script>
    let currentFilter = 'all';
    let currentSort = 'newest';
    let currentPage = 1;
    let resumes = [];
    let filteredResumes = [];

    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    function getCSRFHeaders() {
      const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
      const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

      const headers = {
        'Content-Type': 'application/json'
      };

      if (token && header) {
        headers[header] = token;
      }

      return headers;
    }

    // ìì†Œì„œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadResumes() {
      try {
        showLoading();

        const response = await fetch('/api/resumes', {
          method: 'GET',
          headers: getCSRFHeaders()
        });

        if (response.ok) {
          resumes = await response.json();
          updateStats();
          applyFilters();
          renderResumes();
          hideLoading();
        } else if (response.status === 401 || response.status === 403) {
          hideLoading();
          showEmptyState(true, 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ë¡œê·¸ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        } else {
          throw new Error(`ì„œë²„ ì˜¤ë¥˜ (${response.status})`);
        }
      } catch (error) {
        console.error('Load error:', error);
        hideLoading();

        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          showEmptyState(true, 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
      }
    }

    // í˜ì´ì§€ ì´ˆê¸°í™”
    async function init() {
      await loadResumes();
      setupEventListeners();
    }

    // ìì†Œì„œ ìƒíƒœ íŒë‹¨
    function getResumeStatus(resume) {
      if (resume.status) {
        const statusMapping = {
          'COMPLETED': 'completed',
          'TEMP_SAVED': 'writing',
          'IN_PROGRESS': 'writing',
          'DRAFT': 'writing'
        };

        const mappedStatus = statusMapping[resume.status];
        if (mappedStatus) {
          return mappedStatus;
        }
      }

      const sections = resume.sections || [];
      const totalSections = sections.length;

      if (totalSections === 0) return 'writing';

      const completedSections = sections.filter(s =>
              s.content && s.content.trim().length > 100
      ).length;

      const progress = totalSections > 0 ? (completedSections / totalSections) * 100 : 0;

      if (progress >= 80) return 'completed';
      return 'writing';
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats() {
      const total = resumes.length;
      const completed = resumes.filter(r => getResumeStatus(r) === 'completed').length;
      const writing = resumes.filter(r => getResumeStatus(r) === 'writing').length;

      document.getElementById('totalCount').textContent = total;
      document.getElementById('completedCount').textContent = completed;
      document.getElementById('writingCount').textContent = writing;
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    function setupEventListeners() {
      // ê²€ìƒ‰
      document.getElementById('searchInput').addEventListener('input', function() {
        applyFilters();
        renderResumes();
      });

      // í•„í„° ë²„íŠ¼
      document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          currentFilter = this.dataset.filter;

          currentPage = 1;
          applyFilters();
          renderResumes();
        });
      });

      // ì •ë ¬ ë“œë¡­ë‹¤ìš´
      const sortButton = document.getElementById('sortButton');
      const sortDropdown = document.getElementById('sortDropdown');

      sortButton.addEventListener('click', function(e) {
        e.stopPropagation();
        const dropdown = sortDropdown.closest('.sort-dropdown');
        dropdown.classList.toggle('show');
        sortDropdown.classList.toggle('show');
      });

      // ì •ë ¬ ì˜µì…˜ ì„ íƒ
      document.querySelectorAll('.sort-option').forEach(option => {
        option.addEventListener('click', function() {
          const sortText = this.textContent;
          const sortValue = this.dataset.sort;

          document.getElementById('sortButtonText').textContent = sortText;
          currentSort = sortValue;

          const dropdown = sortDropdown.closest('.sort-dropdown');
          dropdown.classList.remove('show');
          sortDropdown.classList.remove('show');

          currentPage = 1;
          applyFilters();
          renderResumes();
        });
      });

      // ë“œë¡­ë‹¤ìš´ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
      document.addEventListener('click', function(e) {
        const dropdown = document.querySelector('.sort-dropdown');
        dropdown.classList.remove('show');
        document.getElementById('sortDropdown').classList.remove('show');

        if (!e.target.closest('.status-dropdown')) {
          hideAllStatusDropdowns();
        }
      });
    }

    // í•„í„° ì ìš©
    function applyFilters() {
      let filtered = [...resumes];

      // ê²€ìƒ‰ í•„í„°
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      if (searchTerm) {
        filtered = filtered.filter(resume =>
                (resume.title && resume.title.toLowerCase().includes(searchTerm)) ||
                (resume.targetCompany && resume.targetCompany.toLowerCase().includes(searchTerm))
        );
      }

      // ìƒíƒœ í•„í„°
      if (currentFilter !== 'all') {
        filtered = filtered.filter(resume => getResumeStatus(resume) === currentFilter);
      }

      // ì •ë ¬
      filtered.sort((a, b) => {
        const aDate = new Date(a.updated_at || a.updatedAt || a.created_at || a.createdAt);
        const bDate = new Date(b.updated_at || b.updatedAt || b.created_at || b.createdAt);

        if (currentSort === 'newest') {
          return bDate - aDate;
        } else {
          return aDate - bDate;
        }
      });

      filteredResumes = filtered;
    }

    // ìì†Œì„œ ëª©ë¡ ë Œë”ë§
    function renderResumes() {
      const grid = document.getElementById('resumeGrid');

      if (filteredResumes.length === 0) {
        showEmptyState(false);
        return;
      }

      const itemsPerPage = 9;
      const totalPages = Math.ceil(filteredResumes.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const pageResumes = filteredResumes.slice(startIndex, endIndex);

      grid.innerHTML = '';
      grid.style.display = 'grid';

      pageResumes.forEach(resume => {
        const card = createResumeCard(resume);
        grid.appendChild(card);
      });

      renderPagination(totalPages);
      hideEmptyState();
    }

    // ìì†Œì„œ ì¹´ë“œ ìƒì„±
    function createResumeCard(resume) {
      const status = getResumeStatus(resume);

      const statusLabels = {
        'completed': 'ì™„ë£Œ',
        'writing': 'ì‘ì„±ì¤‘'
      };

      const card = document.createElement('div');
      card.className = 'resume-card';
      card.onclick = () => viewResume(resume.id);

      const createdDate = resume.created_at || resume.createdAt;
      const updatedDate = resume.updated_at || resume.updatedAt;

      card.innerHTML = `
                    <div class="resume-title">${resume.title || 'ì œëª© ì—†ìŒ'}</div>
                    <div class="resume-company">${resume.targetCompany || 'íšŒì‚¬ëª… ë¯¸ì„¤ì •'} â€¢ ${resume.position || 'ì§ë¬´ ë¯¸ì„¤ì •'}</div>

                    <div class="status-dropdown">
                      <span class="status-badge status-${status}" onclick="event.stopPropagation(); showStatusDropdown(${resume.id})" title="í´ë¦­í•˜ì—¬ ìƒíƒœ ë³€ê²½">
                        ${statusLabels[status]}
                      </span>
                      <div class="status-dropdown-menu" id="statusDropdown-${resume.id}">
                        <button class="status-option completed" onclick="event.stopPropagation(); changeResumeStatus(${resume.id}, 'completed')">
                          <span class="status-icon"></span>
                          ì™„ë£Œ
                        </button>
                        <button class="status-option writing" onclick="event.stopPropagation(); changeResumeStatus(${resume.id}, 'writing')">
                          <span class="status-icon"></span>
                          ì‘ì„±ì¤‘
                        </button>
                      </div>
                    </div>

                    <div class="resume-dates">
                      <span>ì‘ì„±ì¼: ${formatDate(createdDate)}</span>
                      <span>ìˆ˜ì •ì¼: ${formatDate(updatedDate)}</span>
                    </div>

                    <div class="resume-actions">
                      <button class="action-btn edit-btn" onclick="event.stopPropagation(); editResume(${resume.id})" title="ìˆ˜ì •">
                        âœï¸
                      </button>
                      <button class="action-btn delete-btn" onclick="event.stopPropagation(); deleteResume(${resume.id})" title="ì‚­ì œ">
                        ğŸ—‘ï¸
                      </button>
                    </div>
                  `;

      return card;
    }

    // ìƒíƒœ ë“œë¡­ë‹¤ìš´ í‘œì‹œ
    function showStatusDropdown(resumeId) {
      document.querySelectorAll('.status-dropdown-menu').forEach(menu => {
        menu.classList.remove('show');
      });

      const dropdown = document.getElementById(`statusDropdown-${resumeId}`);
      dropdown.classList.add('show');
    }

    // ìì†Œì„œ ìƒíƒœ ë³€ê²½
    async function changeResumeStatus(resumeId, newStatus) {
      const newStatusBackend = newStatus === 'completed' ? 'COMPLETED' : 'TEMP_SAVED';

      try {
        const response = await fetch(`/api/resumes/${resumeId}`, {
          method: 'PUT',
          headers: getCSRFHeaders(),
          body: JSON.stringify({
            status: newStatusBackend
          })
        });

        if (response.ok) {
          const resumeIndex = resumes.findIndex(r => r.id === resumeId);
          if (resumeIndex !== -1) {
            const oldStatus = getResumeStatus(resumes[resumeIndex]);

            if (oldStatus === newStatus) {
              hideAllStatusDropdowns();
              return;
            }

            resumes[resumeIndex].status = newStatusBackend;
            resumes[resumeIndex].updatedAt = new Date().toISOString();
            if (resumes[resumeIndex].updated_at) {
              resumes[resumeIndex].updated_at = new Date().toISOString();
            }
          }

          updateStats();
          applyFilters();
          renderResumes();

          const statusLabel = newStatus === 'completed' ? 'ì™„ë£Œ' : 'ì‘ì„±ì¤‘';
          const resumeTitle = resumes[resumeIndex]?.title || 'ìì†Œì„œ';
          showStatusToast(`"${resumeTitle}" ìƒíƒœê°€ "${statusLabel}"ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } else {
          throw new Error('ìƒíƒœ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('Status change error:', error);

        console.warn('API ì˜¤ë¥˜ë¡œ ì¸í•´ ì„ì‹œë¡œ ë¡œì»¬ì—ì„œë§Œ ìƒíƒœë¥¼ ë³€ê²½í•©ë‹ˆë‹¤.');

        const resumeIndex = resumes.findIndex(r => r.id === resumeId);
        if (resumeIndex !== -1) {
          const oldStatus = getResumeStatus(resumes[resumeIndex]);

          if (oldStatus === newStatus) {
            hideAllStatusDropdowns();
            return;
          }

          resumes[resumeIndex].status = newStatusBackend;
          resumes[resumeIndex].updatedAt = new Date().toISOString();
          if (resumes[resumeIndex].updated_at) {
            resumes[resumeIndex].updated_at = new Date().toISOString();
          }

          updateStats();
          applyFilters();
          renderResumes();

          const statusLabel = newStatus === 'completed' ? 'ì™„ë£Œ' : 'ì‘ì„±ì¤‘';
          const resumeTitle = resumes[resumeIndex]?.title || 'ìì†Œì„œ';
          showStatusToast(`"${resumeTitle}" ìƒíƒœê°€ "${statusLabel}"ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤. (ì„ì‹œ ë³€ê²½)`);
        }
      }

      hideAllStatusDropdowns();
    }

    // ëª¨ë“  ìƒíƒœ ë“œë¡­ë‹¤ìš´ ìˆ¨ê¸°ê¸°
    function hideAllStatusDropdowns() {
      document.querySelectorAll('.status-dropdown-menu').forEach(menu => {
        menu.classList.remove('show');
      });
    }

    // ìƒíƒœ ë³€ê²½ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ í‘œì‹œ
    function showStatusToast(message) {
      const toast = document.getElementById('statusToast');
      toast.textContent = message;
      toast.classList.add('show');

      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
    function renderPagination(totalPages) {
      const pagination = document.getElementById('pagination');

      if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
      }

      pagination.style.display = 'flex';
      pagination.innerHTML = '';

      const prevBtn = document.createElement('button');
      prevBtn.className = 'page-btn';
      prevBtn.textContent = '<';
      prevBtn.disabled = currentPage === 1;
      prevBtn.onclick = () => changePage(currentPage - 1);
      pagination.appendChild(prevBtn);

      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);

      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.onclick = () => changePage(i);
        pagination.appendChild(pageBtn);
      }

      const nextBtn = document.createElement('button');
      nextBtn.className = 'page-btn';
      nextBtn.textContent = '>';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.onclick = () => changePage(currentPage + 1);
      pagination.appendChild(nextBtn);
    }

    // í˜ì´ì§€ ë³€ê²½
    function changePage(page) {
      currentPage = page;
      renderResumes();
    }

    // ë‚ ì§œ í¬ë§·íŒ…
    function formatDate(dateString) {
      if (!dateString) {
        return '-';
      }

      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) {
          return '-';
        }

        return date.toLocaleDateString('ko-KR', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      } catch (error) {
        console.error('Date formatting error:', error);
        return '-';
      }
    }

    // ìì†Œì„œ ì¡°íšŒ
    function viewResume(resumeId) {
      window.location.href = `/resumes/result?resumeId=${resumeId}`;
    }

    // ìì†Œì„œ ìˆ˜ì •
    function editResume(resumeId) {
      window.location.href = `/resumes/create?resumeId=${resumeId}`;
    }

    // ìì†Œì„œ ì‚­ì œ
    async function deleteResume(resumeId) {
      if (!confirm('ì •ë§ë¡œ ì´ ìì†Œì„œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      try {
        const response = await fetch(`/api/resumes/${resumeId}`, {
          method: 'DELETE',
          headers: getCSRFHeaders()
        });

        if (response.ok) {
          showStatusToast('ìì†Œì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          await loadResumes();
        } else {
          throw new Error('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (error) {
        console.error('Delete error:', error);

        console.warn('API ì˜¤ë¥˜ë¡œ ì¸í•´ ì„ì‹œ ë°ì´í„°ì—ì„œë§Œ ì‚­ì œí•©ë‹ˆë‹¤.');
        resumes = resumes.filter(r => r.id !== resumeId);
        updateStats();
        applyFilters();
        renderResumes();
        showStatusToast('ìì†Œì„œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. (ì„ì‹œ ì‚­ì œ)');
      }
    }

    // ë¡œë”© ìƒíƒœ í‘œì‹œ/ìˆ¨ê¹€
    function showLoading() {
      document.getElementById('loadingState').style.display = 'flex';
      document.getElementById('resumeGrid').style.display = 'none';
      hideEmptyState();
      document.getElementById('pagination').style.display = 'none';
    }

    function hideLoading() {
      document.getElementById('loadingState').style.display = 'none';
    }

    // ë¹ˆ ìƒíƒœ í‘œì‹œ/ìˆ¨ê¹€
    function showEmptyState(isError = false, message = null) {
      const emptyState = document.getElementById('emptyState');
      const emptyTitle = document.getElementById('emptyTitle');
      const emptyMessage = document.getElementById('emptyMessage');
      const retryBtn = document.getElementById('retryBtn');
      const icon = emptyState.querySelector('.icon');

      emptyState.style.display = 'flex';
      document.getElementById('resumeGrid').style.display = 'none';
      document.getElementById('pagination').style.display = 'none';

      if (isError) {
        icon.textContent = 'âš ï¸';
        emptyTitle.textContent = 'ìì†Œì„œ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
        emptyMessage.textContent = message || 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
        retryBtn.style.display = 'inline-block';
      } else {
        icon.textContent = 'ğŸ“';
        emptyTitle.textContent = 'ì•„ì§ ì‘ì„±ëœ ìì†Œì„œê°€ ì—†ìŠµë‹ˆë‹¤';
        emptyMessage.textContent = 'ì²« ë²ˆì§¸ ìì†Œì„œë¥¼ ì‘ì„±í•´ë³´ì„¸ìš”!';
        retryBtn.style.display = 'none';
      }
    }

    function hideEmptyState() {
      const emptyState = document.getElementById('emptyState');
      emptyState.style.display = 'none';
    }

    // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', init);
  </script>
</th:block>
</body>
</html>