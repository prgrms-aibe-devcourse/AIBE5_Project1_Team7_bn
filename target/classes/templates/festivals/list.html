<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>축제 목록 - 한국 축제 발견</title>
    <style>
        .festival-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .festival-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background-color: #fff;
            transition: box-shadow 0.3s;
        }
        .festival-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .festival-card h3 {
            margin-top: 0;
            color: #333;
        }
        .festival-info {
            margin: 10px 0;
            font-size: 14px;
            color: #666;
        }
        .festival-labels {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        .label-badge {
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .category-badge {
            background-color: #f3e5f5;
            color: #7b1fa2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        .filter-section {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .filter-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .filter-group select, .filter-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background-color: #1976d2;
            color: white;
        }
        .btn-secondary {
            background-color: #757575;
            color: white;
        }
        .free-badge {
            background-color: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
<div layout:fragment="content">
    <h1>한국 축제 발견</h1>
    
    <!-- Filter Section -->
    <div class="filter-section">
        <h3>축제 검색 및 필터</h3>
        <div class="filter-row">
            <div class="filter-group">
                <label for="regionFilter">지역</label>
                <select id="regionFilter">
                    <option value="">전체 지역</option>
                    <option th:each="region : ${regions}" th:value="${region}" th:text="${region}"></option>
                </select>
            </div>
            <div class="filter-group">
                <label for="categoryFilter">카테고리</label>
                <select id="categoryFilter">
                    <option value="">전체 카테고리</option>
                    <option th:each="category : ${categories}" th:value="${category}" th:text="${category}"></option>
                </select>
            </div>
            <div class="filter-group">
                <label for="freeFilter">무료 축제</label>
                <select id="freeFilter">
                    <option value="">전체</option>
                    <option value="true">무료</option>
                    <option value="false">유료</option>
                </select>
            </div>
        </div>
        <div class="filter-row">
            <div class="filter-group">
                <label for="startDate">시작일</label>
                <input type="date" id="startDate">
            </div>
            <div class="filter-group">
                <label for="endDate">종료일</label>
                <input type="date" id="endDate">
            </div>
            <div class="filter-group" style="display: flex; align-items: flex-end;">
                <button class="btn btn-primary" onclick="applyFilters()">필터 적용</button>
                <button class="btn btn-secondary" onclick="resetFilters()" style="margin-left: 10px;">초기화</button>
            </div>
        </div>
        <div style="margin-top: 15px;">
            <a href="/festivals/recommend" class="btn btn-primary">맞춤 축제 추천 받기</a>
        </div>
    </div>

    <!-- Festival Grid -->
    <div id="festivalGrid" class="festival-grid">
        <div th:each="festival : ${festivals}" class="festival-card">
            <h3 th:text="${festival.name}">Festival Name</h3>
            <div class="festival-info">
                <strong>기간:</strong> 
                <span th:text="${#temporals.format(festival.startDate, 'yyyy-MM-dd')}"></span> ~ 
                <span th:text="${#temporals.format(festival.endDate, 'yyyy-MM-dd')}"></span>
            </div>
            <div class="festival-info">
                <strong>지역:</strong> <span th:text="${festival.region}"></span>
            </div>
            <div class="festival-info">
                <strong>장소:</strong> <span th:text="${festival.location}"></span>
            </div>
            <div class="festival-info">
                <strong>입장료:</strong>
                <span th:if="${festival.free}" class="free-badge">무료</span>
                <span th:unless="${festival.free}" th:text="${festival.fee != null ? festival.fee + '원' : '별도 문의'}"></span>
            </div>
            <div class="festival-labels">
                <span th:each="category : ${festival.categories}" class="category-badge" th:text="${category}"></span>
                <span th:each="label : ${festival.labels}" class="label-badge" th:text="${label}"></span>
            </div>
            <div style="margin-top: 15px;">
                <a th:href="@{/festivals/{id}(id=${festival.id})}" class="btn btn-primary">자세히 보기</a>
            </div>
        </div>
    </div>

    <script>
        function applyFilters() {
            const region = document.getElementById('regionFilter').value;
            const category = document.getElementById('categoryFilter').value;
            const isFree = document.getElementById('freeFilter').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            const criteria = {
                region: region || null,
                categories: category ? [category] : null,
                isFree: isFree ? (isFree === 'true') : null,
                startDate: startDate || null,
                endDate: endDate || null,
                sortBy: 'date',
                sortOrder: 'asc'
            };

            fetch('/api/festivals/filter', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(criteria)
            })
            .then(response => response.json())
            .then(festivals => {
                renderFestivals(festivals);
            })
            .catch(error => console.error('Error:', error));
        }

        function resetFilters() {
            document.getElementById('regionFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('freeFilter').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
            location.reload();
        }

        function renderFestivals(festivals) {
            const grid = document.getElementById('festivalGrid');
            grid.innerHTML = '';

            if (festivals.length === 0) {
                grid.innerHTML = '<p>검색 결과가 없습니다.</p>';
                return;
            }

            festivals.forEach(festival => {
                const card = document.createElement('div');
                card.className = 'festival-card';
                
                const feeDisplay = festival.free ? 
                    '<span class="free-badge">무료</span>' : 
                    (festival.fee ? festival.fee + '원' : '별도 문의');

                card.innerHTML = `
                    <h3>${festival.name}</h3>
                    <div class="festival-info">
                        <strong>기간:</strong> ${festival.startDate} ~ ${festival.endDate}
                    </div>
                    <div class="festival-info">
                        <strong>지역:</strong> ${festival.region}
                    </div>
                    <div class="festival-info">
                        <strong>장소:</strong> ${festival.location}
                    </div>
                    <div class="festival-info">
                        <strong>입장료:</strong> ${feeDisplay}
                    </div>
                    <div class="festival-labels">
                        ${Array.from(festival.categories).map(cat => 
                            `<span class="category-badge">${cat}</span>`
                        ).join('')}
                        ${Array.from(festival.labels).map(label => 
                            `<span class="label-badge">${label}</span>`
                        ).join('')}
                    </div>
                    <div style="margin-top: 15px;">
                        <a href="/festivals/${festival.id}" class="btn btn-primary">자세히 보기</a>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
    </script>
</div>
</body>
</html>
