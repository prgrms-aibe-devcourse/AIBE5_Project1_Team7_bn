<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<head>
  <title>ìì†Œì„œ ê²°ê³¼</title>
  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

  <!-- í˜ì´ì§€ë³„ ì¶”ê°€ CSS -->
  <th:block layout:fragment="css">
    <style>
      /* í˜ì´ì§€ í—¤ë” */
      .page-header {
        background: white;
        border-bottom: 1px solid #e5e7eb;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .page-header-content {
        max-width: 1400px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem 2rem;
      }

      .header-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .btn-secondary {
        padding: 0.5rem 1rem;
        background: transparent;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        color: #374151;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
      }

      .btn-secondary:hover {
        background: #f9fafb;
        color: #374151;
        text-decoration: none;
      }

      .btn-primary {
        padding: 0.5rem 1rem;
        background: #059669;
        border: 1px solid #059669;
        border-radius: 0.375rem;
        color: white;
        font-size: 0.875rem;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
      }

      .btn-primary:hover {
        background: #047857;
        color: white;
        text-decoration: none;
      }

      .btn-primary:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
      .main-content .container {
        max-width: 1400px !important;
        margin: 0 auto !important;
        display: flex !important;
        gap: 2rem !important;
        padding: 2rem !important;
        min-height: calc(100vh - 200px) !important;
      }

      /* ì™¼ìª½ ì‚¬ì´ë“œë°” */
      .sidebar {
        width: 280px;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 1.5rem;
        height: fit-content;
        position: sticky;
        top: 120px;
      }

      .sidebar-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid #e5e7eb;
      }

      .section-nav {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .nav-item {
        padding: 0.75rem 1rem;
        border-radius: 0.375rem;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.875rem;
        font-weight: 500;
        color: #6b7280;
        border: 1px solid transparent;
      }

      .nav-item:hover {
        background: #f3f4f6;
        color: #374151;
      }

      .nav-item.active {
        background: #eff6ff;
        color: #2563eb;
        border-color: #dbeafe;
      }

      /* ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ */
      .content-area {
        flex: 1;
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        padding: 2rem;
        display: flex;
        flex-direction: column;
      }

      .content-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e5e7eb;
      }

      .content-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.5rem;
      }

      .content-subtitle {
        font-size: 0.875rem;
        color: #6b7280;
      }

      .section {
        display: none;
        flex-direction: column;
        height: 100%;
      }

      .section.active {
        display: flex;
      }

      .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 1.5rem;
      }

      .editor-container {
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      .content-textarea {
        width: 100%;
        min-height: 500px;
        height: 60vh;
        padding: 1.5rem;
        border: 1px solid #d1d5db;
        border-radius: 0.5rem;
        background: white;
        font-size: 1rem;
        line-height: 1.7;
        color: #374151;
        resize: vertical;
        font-family: inherit;
        flex: 1;
      }

      .content-textarea:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .editor-footer {
        display: flex;
        justify-content: stretch;
        align-items: center;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #f3f4f6;
      }

      .char-count {
        font-size: 0.875rem;
        color: #6b7280;
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0 1.5rem;
        flex: 1;
      }

      .char-count-text {
        white-space: nowrap;
        font-weight: 500;
      }

      .progress-bar {
        flex: 1;
        height: 6px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: #3b82f6;
        border-radius: 3px;
        transition: width 0.3s ease;
      }

      /* ë¡œë”© ë° ìƒíƒœ */
      .loading {
        display: none;
        text-align: center;
        padding: 3rem;
        color: #6b7280;
        flex: 1;
        align-items: center;
        justify-content: center;
      }

      .loading.show {
        display: flex;
      }

      .spinner {
        display: inline-block;
        width: 24px;
        height: 24px;
        border: 3px solid #e5e7eb;
        border-radius: 50%;
        border-top-color: #3b82f6;
        animation: spin 1s ease-in-out infinite;
        margin-right: 0.75rem;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .empty-state {
        display: none;
        text-align: center;
        padding: 3rem 2rem;
        color: #6b7280;
        flex: 1;
        align-items: center;
        justify-content: center;
        flex-direction: column;
      }

      .empty-state.show {
        display: flex;
      }

      .empty-state .icon {
        font-size: 4rem;
        margin-bottom: 1.5rem;
        opacity: 0.5;
      }

      .error-message {
        background: #fef2f2;
        border: 1px solid #fecaca;
        color: #b91c1c;
        padding: 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
      }

      /* ìë™ ì €ì¥ í‘œì‹œ */
      .auto-save-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #059669;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1000;
      }

      .auto-save-indicator.show {
        opacity: 1;
      }

      /* íŒŒì¼ ì €ì¥ ëª¨ë‹¬ */
      .export-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999 !important;
        opacity: 0;
        transition: opacity 0.2s ease;
      }

      .export-modal-overlay.show {
        display: flex !important;
        opacity: 1;
      }

      .export-modal {
        background: white;
        border-radius: 12px;
        padding: 0;
        max-width: 420px;
        width: 90%;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        position: relative;
        z-index: 10000;
        transform: scale(0.95);
        transition: transform 0.2s ease;
        overflow: hidden;
      }

      .export-modal-overlay.show .export-modal {
        transform: scale(1);
      }

      .export-modal-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #1f2937;
        margin: 0;
        padding: 1.5rem 1.5rem 1rem;
        text-align: center;
        border-bottom: 1px solid #f3f4f6;
      }

      .export-options {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin: 0;
        padding: 1.5rem;
      }

      .export-option {
        display: flex;
        align-items: center;
        padding: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        background: white;
      }

      .export-option:hover {
        border-color: #3b82f6;
        background: #f8faff;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
      }

      .export-option.selected {
        border-color: #3b82f6;
        background: linear-gradient(to right, #eff6ff, #dbeafe);
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
      }

      .export-option input[type="radio"] {
        margin-right: 0.75rem;
        width: 18px;
        height: 18px;
        accent-color: #3b82f6;
      }

      .export-info {
        flex: 1;
      }

      .export-info h4 {
        font-weight: 600;
        color: #1f2937;
        margin: 0 0 0.25rem 0;
        font-size: 1rem;
      }

      .export-info p {
        font-size: 0.875rem;
        color: #6b7280;
        margin: 0;
        line-height: 1.4;
      }

      .export-modal-actions {
        display: flex;
        gap: 0.75rem;
        justify-content: flex-end;
        padding: 1rem 1.5rem 1.5rem;
        border-top: 1px solid #f3f4f6;
        background: #fafafa;
      }

      .btn-cancel {
        padding: 0.625rem 1.25rem;
        background: white;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        color: #374151;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .btn-cancel:hover {
        background: #f9fafb;
        border-color: #9ca3af;
        transform: translateY(-1px);
      }

      .btn-export {
        padding: 0.625rem 1.5rem;
        background: linear-gradient(to right, #3b82f6, #2563eb);
        border: none;
        border-radius: 6px;
        color: white;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
      }

      .btn-export:hover:not(:disabled) {
        background: linear-gradient(to right, #2563eb, #1d4ed8);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
      }

      .btn-export:disabled {
        background: #9ca3af;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      .btn-export:active {
        transform: translateY(0);
      }

      /* ë°˜ì‘í˜• ë””ìì¸ */
      @media (max-width: 768px) {
        .main-content .container {
          flex-direction: column !important;
          padding: 1rem !important;
        }

        .sidebar {
          width: 100%;
          position: static;
        }

        .section-nav {
          flex-direction: row;
          overflow-x: auto;
          gap: 0.25rem;
        }

        .nav-item {
          white-space: nowrap;
          flex-shrink: 0;
        }

        .content-textarea {
          min-height: 400px;
          height: 50vh;
        }
      }
    </style>
  </th:block>
</head>

<body>
<!-- ë©”ì¸ ì½˜í…ì¸  -->
<div layout:fragment="content">
  <!-- í˜ì´ì§€ í—¤ë” -->
  <div class="page-header">
    <div class="page-header-content">
      <div class="header-actions">
        <a href="/resumes" class="btn-secondary">â† ëª©ë¡ìœ¼ë¡œ</a>
      </div>
      <div class="header-actions">
        <button class="btn-secondary" onclick="showExportModal()" id="exportBtn">ğŸ“„ íŒŒì¼ë¡œ ì €ì¥</button>
        <button class="btn-primary" onclick="saveContent()" id="headerSaveBtn">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ìë™ ì €ì¥ í‘œì‹œ -->
  <div id="autoSaveIndicator" class="auto-save-indicator">
    âœ… ìë™ ì €ì¥ë¨
  </div>

  <!-- íŒŒì¼ ì €ì¥ ëª¨ë‹¬ -->
  <div id="exportModal" class="export-modal-overlay" onclick="closeExportModal(event)">
    <div class="export-modal" onclick="event.stopPropagation()">
      <div class="export-modal-title">íŒŒì¼ë¡œ ì €ì¥í•˜ê¸°</div>

      <div class="export-options">
        <label class="export-option" onclick="selectExportOption('pdf')">
          <input type="radio" name="exportType" value="pdf">
          <div class="export-info">
            <h4>ğŸ“„ PDF íŒŒì¼</h4>
            <p>ì¸ì‡„ìš©ìœ¼ë¡œ ì í•©í•œ PDF í˜•ì‹</p>
          </div>
        </label>

        <label class="export-option" onclick="selectExportOption('docx')">
          <input type="radio" name="exportType" value="docx">
          <div class="export-info">
            <h4>ğŸ“ Word ë¬¸ì„œ</h4>
            <p>í¸ì§‘ ê°€ëŠ¥í•œ Word ë¬¸ì„œ (DOCX)</p>
          </div>
        </label>

        <label class="export-option" onclick="selectExportOption('txt')">
          <input type="radio" name="exportType" value="txt">
          <div class="export-info">
            <h4>ğŸ“‹ í…ìŠ¤íŠ¸ íŒŒì¼</h4>
            <p>ìˆœìˆ˜ í…ìŠ¤íŠ¸ í˜•ì‹ (TXT)</p>
          </div>
        </label>
      </div>

      <div class="export-modal-actions">
        <button class="btn-cancel" onclick="closeExportModal()">ì·¨ì†Œ</button>
        <button class="btn-export" onclick="exportFile()" id="exportConfirmBtn" disabled>ë‚´ë³´ë‚´ê¸°</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
    <div class="sidebar">
      <div class="sidebar-title" id="resumeTitle">ìê¸°ì†Œê°œì„œ</div>
      <div class="section-nav" id="sectionNavigation">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ë„¤ë¹„ê²Œì´ì…˜ í•­ëª©ë“¤ -->
      </div>
    </div>

    <!-- ë©”ì¸ ì½˜í…ì¸  ì˜ì—­ -->
    <div class="content-area">
      <div id="loadingSection" class="loading">
        <div class="spinner"></div>
        ìì†Œì„œë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...
      </div>

      <div id="contentSection">
        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë  ì„¹ì…˜ë“¤ -->
      </div>

      <div id="emptyState" class="empty-state">
        <div class="icon">ğŸ“</div>
        <h3>ìì†Œì„œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤</h3>
        <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
      </div>
    </div>
  </div>
</div>

<!-- í˜ì´ì§€ë³„ JavaScript -->
<th:block layout:fragment="script">
  <script>
    let resumeId = null;
    let currentSections = [];
    let autoSaveInterval = null;
    let selectedExportType = null;

    // SectionType ë§¤í•‘
    const sectionTypeMapping = {
      'GROWTH': 'ì„±ì¥ê³¼ì •',
      'PERSONALITY': 'ì„±ê²©ì˜ ì¥ë‹¨ì ',
      'MOTIVATION': 'ì§€ì›ë™ê¸°',
      'GOALS': 'ì…ì‚¬ í›„ í¬ë¶€',
      'ASPIRATION': 'ì…ì‚¬ í›„ í¬ë¶€',
      'PROJECT': 'í”„ë¡œì íŠ¸ ê²½í—˜',
      'STRENGTH': 'ê°•ì ',
      'EXPERIENCE': 'ê²½í—˜/í™œë™',
      'GOAL': 'ëª©í‘œ',
      'OTHER': 'ê¸°íƒ€'
    };

    // ê¸°ë³¸ ê¸€ììˆ˜ ì œí•œ
    const defaultCharLimit = 1000;

    // URLì—ì„œ resumeId íŒŒë¼ë¯¸í„° ì¶”ì¶œ
    function getResumeIdFromUrl() {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get('resumeId');
    }

    // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
    function getCSRFHeaders() {
      const token = document.querySelector('meta[name="_csrf"]')?.getAttribute('content');
      const header = document.querySelector('meta[name="_csrf_header"]')?.getAttribute('content');

      const headers = {
        'Content-Type': 'application/json'
      };

      if (token && header) {
        headers[header] = token;
      }

      return headers;
    }

    // í˜ì´ì§€ ë¡œë“œì‹œ ìì†Œì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadResumeData() {
      resumeId = getResumeIdFromUrl();
      if (!resumeId) {
        showError('Resume IDê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      try {
        showLoading();

        const response = await fetch(`/gemini/result/${resumeId}`, {
          method: 'GET',
          headers: getCSRFHeaders()
        });

        if (response.ok) {
          const resumeData = await response.json();
          displayResumeData(resumeData);
        } else {
          const errorText = await response.text();
          throw new Error(`ìì†Œì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ${errorText}`);
        }
      } catch (error) {
        console.error('Load error:', error);
        showError(error.message);
      }
    }

    // ë¡œë”© ìƒíƒœ í‘œì‹œ
    function showLoading() {
      document.getElementById('loadingSection').classList.add('show');
      document.getElementById('contentSection').style.display = 'none';
      document.getElementById('emptyState').classList.remove('show');
    }

    // ìì†Œì„œ ë°ì´í„° í‘œì‹œ
    function displayResumeData(resumeData) {
      document.getElementById('loadingSection').classList.remove('show');
      document.getElementById('emptyState').classList.remove('show');
      document.getElementById('contentSection').style.display = 'block';

      // ì œëª© ì—…ë°ì´íŠ¸
      document.getElementById('resumeTitle').textContent = resumeData.title || 'ìê¸°ì†Œê°œì„œ';

      // ì„¹ì…˜ ë°ì´í„° ì €ì¥
      currentSections = resumeData.sections || [];

      if (currentSections.length === 0) {
        showEmptySection();
        return;
      }

      // ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜ ìƒì„±
      createSectionNavigation();

      // ì„¹ì…˜ ì½˜í…ì¸  ìƒì„±
      createSectionContents();

      // ìë™ ì €ì¥ ì‹œì‘
      startAutoSave();
    }

    // ë¹ˆ ì„¹ì…˜ í‘œì‹œ
    function showEmptySection() {
      const emptyState = document.getElementById('emptyState');
      emptyState.classList.add('show');
      emptyState.innerHTML = `
                  <div class="icon">ğŸ“</div>
                  <h3>ìƒì„±ëœ ìì†Œì„œ ì„¹ì…˜ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                  <p>ìì†Œì„œ ìƒì„±ì„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                `;
    }

    // ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜ ìƒì„±
    function createSectionNavigation() {
      const sectionNavigation = document.getElementById('sectionNavigation');
      sectionNavigation.innerHTML = '';

      currentSections.forEach((section, index) => {
        const sectionType = section.section_type || section.sectionType;

        if (!sectionType) {
          console.warn('Section without sectionType found:', section);
          return;
        }

        const sectionTitle = sectionTypeMapping[sectionType] || sectionType;
        const navItem = document.createElement('div');
        navItem.className = `nav-item ${index === 0 ? 'active' : ''}`;
        navItem.textContent = sectionTitle;
        navItem.onclick = () => switchSection(sectionType, navItem);
        sectionNavigation.appendChild(navItem);
      });
    }

    // ì„¹ì…˜ ì½˜í…ì¸  ìƒì„±
    function createSectionContents() {
      const contentSection = document.getElementById('contentSection');
      contentSection.innerHTML = '';

      currentSections.forEach((section, index) => {
        const sectionType = section.section_type || section.sectionType;

        if (!sectionType) {
          console.warn('Section without sectionType found:', section);
          return;
        }

        const sectionTitle = sectionTypeMapping[sectionType] || sectionType;
        const sectionId = sectionType.toLowerCase();

        const sectionDiv = document.createElement('div');
        sectionDiv.className = `section ${index === 0 ? 'active' : ''}`;
        sectionDiv.id = `section-${sectionId}`;

        sectionDiv.innerHTML = `
                        <div class="content-header">
                          <div class="content-title">${sectionTitle}</div>
                          <div class="content-subtitle">${sectionTitle}ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.</div>
                        </div>

                        <div class="editor-container">
                          <textarea
                            class="content-textarea"
                            id="${sectionId}Content"
                            placeholder="${sectionTitle} ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”..."
                            oninput="updateCharCount('${sectionId}Content', '${sectionId}Count', ${defaultCharLimit})"
                          >${section.content || ''}</textarea>

                          <div class="editor-footer">
                            <div class="char-count">
                              <span class="char-count-text">
                                <span id="${sectionId}Count">0</span> / ${defaultCharLimit}
                              </span>
                              <div class="progress-bar">
                                <div class="progress-fill" id="${sectionId}Progress" style="width: 0%"></div>
                              </div>
                            </div>
                          </div>
                        </div>
                      `;

        contentSection.appendChild(sectionDiv);

        // ì´ˆê¸° ê¸€ììˆ˜ ì¹´ìš´íŠ¸
        setTimeout(() => {
          updateCharCount(`${sectionId}Content`, `${sectionId}Count`, defaultCharLimit);
        }, 100);
      });
    }

    // ì„¹ì…˜ ì „í™˜
    function switchSection(sectionType, clickedNav) {
      // ëª¨ë“  ë„¤ë¹„ê²Œì´ì…˜ ë¹„í™œì„±í™”
      document.querySelectorAll('.nav-item').forEach(nav => {
        nav.classList.remove('active');
      });

      // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê¸°
      document.querySelectorAll('.section').forEach(section => {
        section.classList.remove('active');
      });

      // ì„ íƒëœ ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
      clickedNav.classList.add('active');

      // ì„ íƒëœ ì„¹ì…˜ í‘œì‹œ
      const sectionId = sectionType.toLowerCase();
      const sectionElement = document.getElementById(`section-${sectionId}`);
      if (sectionElement) {
        sectionElement.classList.add('active');
      }
    }

    // ì—ëŸ¬ ìƒíƒœ í‘œì‹œ
    function showError(message) {
      document.getElementById('loadingSection').classList.remove('show');
      document.getElementById('contentSection').style.display = 'none';

      const emptyState = document.getElementById('emptyState');
      emptyState.classList.add('show');
      emptyState.innerHTML = `
                  <div class="icon">âš ï¸</div>
                  <h3>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤</h3>
                  <p>${message}</p>
                  <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #3b82f6; color: white; border: none; border-radius: 0.375rem; cursor: pointer;">
                    ë‹¤ì‹œ ì‹œë„
                  </button>
                `;
    }

    // ê¸€ììˆ˜ ì¹´ìš´íŠ¸ ë° í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì—…ë°ì´íŠ¸
    function updateCharCount(textareaId, countId, maxLength) {
      const textarea = document.getElementById(textareaId);
      const countElement = document.getElementById(countId);
      const progressElement = document.getElementById(textareaId.replace('Content', 'Progress'));

      if (!textarea || !countElement || !progressElement) return;

      const currentLength = textarea.value.length;
      const percentage = (currentLength / maxLength) * 100;

      countElement.textContent = currentLength;
      progressElement.style.width = Math.min(percentage, 100) + '%';

      // ê¸€ììˆ˜ê°€ ì´ˆê³¼ë˜ë©´ ìƒ‰ìƒ ë³€ê²½
      if (currentLength > maxLength) {
        countElement.style.color = '#ef4444';
        progressElement.style.background = '#ef4444';
      } else {
        countElement.style.color = '#6b7280';
        progressElement.style.background = '#3b82f6';
      }
    }

    // ì €ì¥ ê¸°ëŠ¥
    async function saveContent(isAutoSave = false) {
      if (!resumeId || currentSections.length === 0) {
        if (!isAutoSave) {
          alert('ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
        }
        return;
      }

      const saveBtn = document.getElementById('headerSaveBtn');
      const originalText = saveBtn.textContent;

      if (!isAutoSave) {
        saveBtn.disabled = true;
        saveBtn.textContent = 'ì €ì¥ ì¤‘...';
      }

      try {
        for (const section of currentSections) {
          const sectionType = section.section_type || section.sectionType;
          const sectionId = sectionType.toLowerCase();
          const textarea = document.getElementById(`${sectionId}Content`);

          if (textarea) {
            await fetch(`/api/resumes/${resumeId}/sections`, {
              method: 'POST',
              headers: getCSRFHeaders(),
              body: JSON.stringify({
                section_type: sectionType,
                content: textarea.value.trim()
              })
            });
          }
        }

        if (isAutoSave) {
          // ìë™ ì €ì¥ í‘œì‹œ
          showAutoSaveIndicator();
        } else {
          // ìˆ˜ë™ ì €ì¥ ì™„ë£Œ ì•Œë¦¼
          saveBtn.textContent = 'âœ… ì €ì¥ì™„ë£Œ';
          saveBtn.style.background = '#059669';

          setTimeout(() => {
            saveBtn.textContent = originalText;
            saveBtn.style.background = '#059669';
            saveBtn.disabled = false;
          }, 2000);
        }

      } catch (error) {
        console.error('Save error:', error);
        if (!isAutoSave) {
          alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
          saveBtn.textContent = originalText;
          saveBtn.disabled = false;
        }
      }
    }

    // ìë™ ì €ì¥ ì‹œì‘
    function startAutoSave() {
      if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
      }

      // 5ë¶„(300,000ms)ë§ˆë‹¤ ìë™ ì €ì¥
      autoSaveInterval = setInterval(() => {
        saveContent(true);
      }, 300000);
    }

    // ìë™ ì €ì¥ í‘œì‹œ
    function showAutoSaveIndicator() {
      const indicator = document.getElementById('autoSaveIndicator');
      indicator.classList.add('show');

      setTimeout(() => {
        indicator.classList.remove('show');
      }, 3000);
    }

    // íŒŒì¼ ì €ì¥ ëª¨ë‹¬ í‘œì‹œ
    function showExportModal() {
      const modal = document.getElementById('exportModal');
      if (modal) {
        modal.classList.add('show');

        // ì„ íƒ ì´ˆê¸°í™”
        selectedExportType = null;
        document.getElementById('exportConfirmBtn').disabled = true;
        document.querySelectorAll('.export-option').forEach(option => {
          option.classList.remove('selected');
        });
        document.querySelectorAll('input[name="exportType"]').forEach(radio => {
          radio.checked = false;
        });
      } else {
        console.error('ëª¨ë‹¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
      }
    }

    // íŒŒì¼ ì €ì¥ ëª¨ë‹¬ ë‹«ê¸°
    function closeExportModal(event) {
      if (event && event.target !== event.currentTarget) return;

      const modal = document.getElementById('exportModal');
      if (modal) {
        modal.classList.remove('show');
      }
    }

    // ë‚´ë³´ë‚´ê¸° í˜•ì‹ ì„ íƒ
    function selectExportOption(type) {
      selectedExportType = type;

      // ëª¨ë“  ì˜µì…˜ ì„ íƒ í•´ì œ
      document.querySelectorAll('.export-option').forEach(option => {
        option.classList.remove('selected');
      });

      // ì„ íƒëœ ì˜µì…˜ í™œì„±í™”
      const selectedOption = document.querySelector(`input[value="${type}"]`).closest('.export-option');
      selectedOption.classList.add('selected');

      // ë¼ë””ì˜¤ ë²„íŠ¼ ì²´í¬
      document.querySelector(`input[value="${type}"]`).checked = true;

      // ë‚´ë³´ë‚´ê¸° ë²„íŠ¼ í™œì„±í™”
      document.getElementById('exportConfirmBtn').disabled = false;
    }

    // íŒŒì¼ ë‚´ë³´ë‚´ê¸°
    async function exportFile() {
      if (!selectedExportType || !resumeId) {
        alert('ë‚´ë³´ë‚¼ í˜•ì‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      const exportBtn = document.getElementById('exportConfirmBtn');
      const originalText = exportBtn.textContent;
      exportBtn.disabled = true;
      exportBtn.textContent = 'ë‚´ë³´ë‚´ëŠ” ì¤‘...';

      try {
        // ë¨¼ì € í˜„ì¬ ë‚´ìš© ì €ì¥
        await saveContent(true);

        // íŒŒì¼ ë‚´ë³´ë‚´ê¸° API í˜¸ì¶œ
        const response = await fetch(`/api/resumes/${resumeId}/export`, {
          method: 'POST',
          headers: getCSRFHeaders(),
          body: JSON.stringify({
            format: selectedExportType
          })
        });

        if (response.ok) {
          // íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;

          // íŒŒì¼ëª… ì„¤ì •
          const resumeTitle = document.getElementById('resumeTitle').textContent || 'ìê¸°ì†Œê°œì„œ';
          const extension = selectedExportType === 'docx' ? 'docx' : selectedExportType;
          a.download = `${resumeTitle}.${extension}`;

          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);

          // ëª¨ë‹¬ ë‹«ê¸°
          closeExportModal();

          // ì„±ê³µ ë©”ì‹œì§€
          exportBtn.textContent = 'âœ… ì™„ë£Œ';
          setTimeout(() => {
            exportBtn.textContent = originalText;
            exportBtn.disabled = false;
          }, 2000);

        } else {
          const errorText = await response.text();
          throw new Error(`íŒŒì¼ ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${errorText}`);
        }

      } catch (error) {
        console.error('Export error:', error);
        alert('íŒŒì¼ ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        exportBtn.textContent = originalText;
        exportBtn.disabled = false;
      }
    }

    // í˜ì´ì§€ ë¡œë“œì‹œ ì‹¤í–‰
    document.addEventListener('DOMContentLoaded', loadResumeData);

    // í˜ì´ì§€ ë– ë‚  ë•Œ ìë™ ì €ì¥ ì •ë¦¬
    window.addEventListener('beforeunload', () => {
      if (autoSaveInterval) {
        clearInterval(autoSaveInterval);
      }
    });
  </script>
</th:block>
</body>
</html>